<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lectura MÃ¡gica - Â¡Aprende Jugando!</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Fredoka', sans-serif; background-color: #f0f9ff; background-image: radial-gradient(#bae6fd 1.5px, transparent 1.5px); background-size: 25px 25px; }
    .child-card { background: white; border-radius: 3rem; border-bottom: 8px solid #e2e8f0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    /* Nuevo estilo para las tarjetas de sÃ­labas (inicial colorido y atractivo) */
    .syllable-btn {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 1.5rem;
      border: 3px solid rgba(0,0,0,0.06);
      transition: transform 220ms cubic-bezier(.2,.9,.2,1), box-shadow 220ms, border-color 220ms, background-color 220ms;
      cursor: pointer;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.98));
      position: relative;
      overflow: visible;
      min-height: 96px;
      box-shadow: 0 2px 6px rgba(15,23,42,0.05);
      user-select: none;
    }
    .syllable-btn .icon-container { width: 48px; height: 48px; display:flex; align-items:center; justify-content:center; transition: all 220ms; opacity: 0.28; }
    .syllable-btn span { transition: color 200ms, transform 200ms; color: #1e293b; }
    .syllable-btn:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.12); }
    .syllable-btn.active {
      transform: scale(1.08);
      border-style: solid;
      box-shadow: 0 18px 40px rgba(2,6,23,0.14);
    }
    /* Check animado */
    .syllable-check {
      position: absolute;
      right: -8px;
      top: -8px;
      background: #16a34a;
      color: white;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      border: 3px solid white;
      transform: scale(0);
      transition: transform 260ms cubic-bezier(.2,.9,.2,1);
      box-shadow: 0 6px 20px rgba(16,185,129,0.18);
    }
    .syllable-check.show { transform: scale(1); }
    .bounce { animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    /* Ocultar scrollbar */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* PequeÃ±as responsividades */
    @media (min-width: 768px) {
      .syllable-btn { min-height: 120px; border-radius: 2rem; }
      .syllable-btn .icon-container { width: 56px; height: 56px; }
    }

    @media (max-width: 768px) {
  #result-area {
    padding-bottom: 120px;
  }
}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">
  <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b-4 border-yellow-400 p-4 shadow-sm">
    <div class="max-w-5xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-br from-yellow-400 to-orange-500 p-3 rounded-2xl shadow-lg rotate-3">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m4 19.5 5-2.5 5 2.5 5-2.5V4.5l-5 2.5-5-2.5-5 2.5z"/><path d="M9 4.5v12.5"/><path d="M14 6.5v12.5"/></svg>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-black text-blue-600 tracking-tight uppercase">Lectura MÃ¡gica</h1>
          <p class="text-xs font-bold text-orange-500 tracking-widest uppercase">Â¡Aventura de sonidos!</p>
        </div>
      </div>
      <div class="flex items-center gap-3 w-full md:w-auto">
        <select id="word-selector" onchange="changeWord(this.value)" class="flex-1 md:w-64 bg-blue-50 border-3 border-blue-200 py-3 px-4 rounded-2xl font-bold text-blue-700 focus:outline-none focus:border-blue-500 appearance-none cursor-pointer"></select>
        <button onclick="exportToPDF(true)" class="bg-pink-500 hover:bg-pink-600 text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 shadow-[0_4px_0_#be185d] active:translate-y-1 active:shadow-none transition-all">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          PDF
        </button>
      </div>
    </div>
  </header>

  <section class="max-w-5xl mx-auto p-6 space-y-4">

  <div class="bg-white p-6 rounded-3xl shadow-xl border-4 border-blue-200 space-y-4">

    <h2 class="text-xl font-black text-blue-600">ConfiguraciÃ³n del PDF</h2>

    <label class="font-bold text-sm text-blue-600">DATA (JSON)</label>
    <textarea id="json-input"
      class="w-full h-40 p-4 border-2 border-blue-200 rounded-2xl"
      placeholder='[ { "word":"MAMA", "image":"img001.jpg", "rows":[ {"syllable":"MA","color":"blue","shape":"Circle"} ] } ]'>[
  {
    "id": 1,
    "word": "PERRO",
    "image": "img001.png",
    "image_prompt": "Cute original yellow electric creature with long pointy ears and red cheeks, cartoon style, standing and smiling while pointing at a friendly brown puppy beside him, white background, high quality vector illustration.",
    "rows": [
      { "syllable": "PE", "color": "brown", "shape": "Circle" },
      { "syllable": "RRO", "color": "orange", "shape": "Square" }
    ]
  },
  {
    "id": 2,
    "word": "GATO",
    "image": "img002.png",
    "image_prompt": "Cute original yellow electric creature with big eyes and lightning tail, happily pointing at a small grey kitten, cartoon style, white background, colorful clean vector.",
    "rows": [
      { "syllable": "GA", "color": "grey", "shape": "Triangle" },
      { "syllable": "TO", "color": "pink", "shape": "Circle" }
    ]
  },
  {
    "id": 3,
    "word": "CONEJO",
    "image": "img003.png",
    "image_prompt": "Original yellow electric character smiling and pointing at a white bunny eating a carrot, playful pose, cartoon style, white background, bright children illustration.",
    "rows": [
      { "syllable": "CO", "color": "blue", "shape": "Square" },
      { "syllable": "NE", "color": "green", "shape": "Hexagon" },
      { "syllable": "JO", "color": "yellow", "shape": "Diamond" }
    ]
  },
  {
    "id": 4,
    "word": "PELOTA",
    "image": "img004.png",
    "image_prompt": "Original yellow electric creature kicking a colorful soccer ball and pointing at it, energetic pose, cartoon 3D style, white background.",
    "rows": [
      { "syllable": "PE", "color": "red", "shape": "Circle" },
      { "syllable": "LO", "color": "white", "shape": "Pentagon" },
      { "syllable": "TA", "color": "blue", "shape": "Square" }
    ]
  },

  {
    "id": 5,
    "word": "JIRAFA",
    "image": "img005.png",
    "image_prompt": "Cute yellow electric character pointing up at a tall friendly giraffe, cartoon style, bright colors, white background.",
    "rows": [
      { "syllable": "JI", "color": "amber", "shape": "Triangle" },
      { "syllable": "RA", "color": "orange", "shape": "Circle" },
      { "syllable": "FA", "color": "brown", "shape": "Hexagon" }
    ]
  },

  {
    "id": 6,
    "word": "BALLENA",
    "image": "img006.png",
    "image_prompt": "Original yellow electric character inside a small blue submarine window pointing at a happy whale underwater, cartoon style, white background.",
    "rows": [
      { "syllable": "BA", "color": "cyan", "shape": "Square" },
      { "syllable": "LLE", "color": "blue", "shape": "Circle" },
      { "syllable": "NA", "color": "teal", "shape": "Diamond" }
    ]
  },

  {
    "id": 7,
    "word": "TORTUGA",
    "image": "img007.png",
    "image_prompt": "Yellow electric creature crouching and smiling while pointing at a slow green turtle, cute cartoon style, white background.",
    "rows": [
      { "syllable": "TOR", "color": "green", "shape": "Hexagon" },
      { "syllable": "TU", "color": "lime", "shape": "Triangle" },
      { "syllable": "GA", "color": "brown", "shape": "Circle" }
    ]
  },

  {
    "id": 8,
    "word": "PLATANO",
    "image": "img008.png",
    "image_prompt": "Happy yellow electric character holding and pointing at a ripe banana, cartoon style, bright colors, white background.",
    "rows": [
      { "syllable": "PLA", "color": "yellow", "shape": "Square" },
      { "syllable": "TA", "color": "amber", "shape": "Circle" },
      { "syllable": "NO", "color": "green", "shape": "Diamond" }
    ]
  },

  {
    "id": 9,
    "word": "HELADO",
    "image": "img009.png",
    "image_prompt": "Original yellow electric character excitedly pointing at a colorful ice cream cone, cartoon style, white background.",
    "rows": [
      { "syllable": "HE", "color": "pink", "shape": "Circle" },
      { "syllable": "LA", "color": "brown", "shape": "Triangle" },
      { "syllable": "DO", "color": "orange", "shape": "Square" }
    ]
  },

  {
    "id": 10,
    "word": "COHETE",
    "image": "img010.png",
    "image_prompt": "Cute yellow electric character wearing astronaut helmet pointing at a red and white rocket launching, cartoon style, white background.",
    "rows": [
      { "syllable": "CO", "color": "red", "shape": "Triangle" },
      { "syllable": "HE", "color": "blue", "shape": "Square" },
      { "syllable": "TE", "color": "grey", "shape": "Hexagon" }
    ]
  }
]
</textarea>

    <label class="font-bold text-sm text-blue-600">ZIP de imÃ¡genes</label>
    <input type="file" id="zip-input" accept=".zip"
      class="w-full border-2 border-blue-200 rounded-2xl p-3" />

    <label class="font-bold text-sm text-blue-600">Nombre del PDF</label>
    <input type="text" id="pdf-name"
      placeholder="Album_Lectura_Magica"
      class="w-full border-2 border-blue-200 rounded-2xl p-3" />

  </div>

</section>


<main class="flex-1 max-w-4xl mx-auto w-full p-4 md:p-8 space-y-12 pb-[160px] md:pb-24">
    <section class="text-center space-y-8">
      <div class="inline-block bg-white px-6 py-2 rounded-full shadow-sm border-2 border-blue-100">
        <span class="text-blue-500 font-black text-sm uppercase tracking-widest">Paso 1: Â¡Toca y escucha! ðŸŽµ</span>
      </div>
      <div id="game-grid" class="grid grid-cols-1 gap-8"></div>
    </section>

    <section id="result-area" class="pb-24 opacity-20 pointer-events-none transition-all duration-700">
      <div class="text-center mb-8">
        <span class="bg-green-100 text-green-600 px-6 py-2 rounded-full font-black text-sm uppercase">Paso 2: Â¡Palabra completa! ðŸŒŸ</span>
      </div>
      <div id="final-card" class="child-card p-8 md:p-12 flex flex-col items-center gap-8 shadow-xl border-t-8 border-green-400"></div>
    </section>
  </main>

<!-- Footer reemplazado: mÃ¡s espaciado y responsive -->
<footer class="hidden sm:block fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-2xl bg-white/90 backdrop-blur-md border-4 border-blue-400 p-4 md:p-5 rounded-3xl shadow-2xl z-40">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <!-- Meta (label + count) -->
    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="flex flex-col sm:flex-row sm:items-center gap-1">
        <span id="progress-label" class="text-blue-600 font-black text-xs uppercase italic">Â¡Vamos, tÃº puedes!</span>
        <span id="progress-count" class="text-blue-600 font-black text-xs flex-shrink-0">0/0</span>
      </div>
      <!-- separador opcional en pantallas md+ -->
      <div class="hidden md:block w-px h-8 bg-blue-100 ml-3"></div>
    </div>

    <!-- Barra de progreso (ocupa el resto) -->
    <div class="w-full md:ml-4">
      <div class="h-4 bg-blue-100 rounded-full overflow-hidden border-2 border-blue-200">
        <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-400 to-indigo-500 transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
  </div>
</footer>


  <script>
    let DATA = [];
    let currentWordIdx = 0;
    let playedSyllables = new Set();
    let isSpeaking = false;

    const COLORS = {
      blue: { main: '#3b82f6', light: '#eff6ff', rgb: [59,130,246] },
      green: { main: '#22c55e', light: '#f0fdf4', rgb: [34,197,94] },
      red: { main: '#ef4444', light: '#fef2f2', rgb: [239,68,68] },
      purple: { main: '#a855f7', light: '#faf5ff', rgb: [168,85,247] },
      orange: { main: '#f97316', light: '#fff7ed', rgb: [249,115,22] },
      pink: { main: '#ec4899', light: '#fdf2f8', rgb: [236,72,153] },
      yellow: { main: '#eab308', light: '#fefce8', rgb: [234,179,8] }
    };

    // Devuelve markup SVG como string (se inyecta en innerHTML)
    function getShapeSVG(shape) {
      const icons = {
        Circle: '<circle cx="12" cy="12" r="10"/>',
        Square: '<rect x="4" y="4" width="16" height="16" rx="2"/>',
        Triangle: '<path d="M12 2L2 20h20L12 2z"/>',
        Diamond: '<path d="M12 2l10 10-10 10L2 12 12 2z"/>',
        Star: '<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>'
      };
      return '<svg viewBox="0 0 24 24" fill="currentColor" class="w-full h-full">' + (icons[shape] || icons.Circle) + '</svg>';
    }



    async function speak(text, slow = false) {
      if (isSpeaking) return;
      isSpeaking = true;
      for (let i = 0; i < 3; i++) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'es-ES';
        u.rate = slow ? 0.7 : 0.9;
        window.speechSynthesis.speak(u);
        await new Promise(r => setTimeout(r, 650));
      }
      isSpeaking = false;
    }

    // Toggle mejorado: aÃ±ade animaciÃ³n, check, actualiza progreso y scroll para la Ãºltima columna
    function toggleSyllable(id, syllable, el) {
      speak(syllable);
      if (playedSyllables.has(id)) return;
      playedSyllables.add(id);

      // estilos visuales cuando se activa
      el.classList.add('active');
      // extraemos rowIdx y colIdx para decidir scroll
      const [rowIdx, colIdx] = id.split('-').map(Number);
      const row = DATA[currentWordIdx].rows[rowIdx] || {};
      const colorKey = row.color ? row.color.toLowerCase() : 'blue';
      const color = COLORS[colorKey] || COLORS.blue;

      // Colorizamos la tarjeta al activarse
      el.style.borderColor = color.main;
      el.style.background = `linear-gradient(180deg, ${color.light}, rgba(255,255,255,0.95))`;
      el.querySelector('.icon-container').style.opacity = "1";
      el.querySelector('.icon-container').style.color = color.main;
      el.querySelector('span').style.color = color.main;

      // Check animado (solo si no existe aÃºn)
      if (!el.querySelector('.syllable-check')) {
        const check = document.createElement('div');
        check.className = "syllable-check";
        check.innerHTML = "âœ“";
        el.appendChild(check);
        // forzar repaint y mostrar
        setTimeout(()=> check.classList.add('show'), 30);
      }

      updateProgress();

      // Si se hace click en la Ãºltima tarjeta (col 2, Ã­ndice 2), centramos la siguiente fila
      if (colIdx === 2) {
        setTimeout(() => {
          const rowsEls = Array.from(document.querySelectorAll('#game-grid > .row-grid'));
          const next = rowsEls[rowIdx + 1];
          if (next) {
            next.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // tambiÃ©n damos un pequeÃ±o efecto a la fila siguiente
            next.classList.add('bounce');
            setTimeout(()=> next.classList.remove('bounce'), 900);
          }
        }, 300);
      }
    }

    function updateProgress() {
      const total = DATA[currentWordIdx].rows.length * 3;
      const current = playedSyllables.size;
      const perc = (total === 0) ? 0 : (current / total) * 100;
      document.getElementById('progress-bar').style.width = perc + "%";
      document.getElementById('progress-count').innerText = `${current} / ${total}`;
      if (current === total && total > 0) {
        const area = document.getElementById('result-area');
        area.classList.remove('opacity-20', 'pointer-events-none');
        area.scrollIntoView({ behavior: 'smooth' });
        speak(DATA[currentWordIdx].word, true);
      }
    }

    // Renderizado completo y con estilos iniciales (las tarjetas NO aparecen desactivadas)
    function renderApp() {
      playedSyllables.clear();
      const wordData = DATA[currentWordIdx];
      if (!wordData) return;

      // GRID de sÃ­labas: cada fila tiene clase row-grid (Ãºtil para scroll centrar)
      const gridHTML = wordData.rows.map((row, rIdx) => {
        const colorKey = row.color ? row.color.toLowerCase() : 'blue';
        const colorData = COLORS[colorKey] || COLORS.blue;
        const bg = colorData.light;
        const border = colorData.main;
        const iconColor = colorData.main;
        // cada fila es una sub-grid de 3
        const cells = [0,1,2].map(cIdx => {
          return `
            <div class="syllable-btn relative group" onclick="toggleSyllable('${rIdx}-${cIdx}','${row.syllable.replace(/'/g,"\\'")}', this)"
                 style="border-color:${border}; background: linear-gradient(180deg, ${bg}, rgba(255,255,255,0.96));">
              <div class="icon-container" style="opacity:0.9; color:${iconColor}">${getShapeSVG(row.shape)}</div>
              <span class="text-3xl md:text-5xl font-black uppercase" style="color:${iconColor}">${row.syllable}</span>
            </div>
          `;
        }).join('');
        return `<div class="grid grid-cols-3 gap-4 md:gap-8 row-grid">${cells}</div>`;
      }).join('');

      document.getElementById('game-grid').innerHTML = gridHTML;

      // Card final (imagen + sÃ­labas con colores)
      const finalCardHTML = `
        <div class="bg-blue-50 p-6 rounded-[2.5rem] border-4 border-white shadow-inner bounce">
<img src="${wordData.image}"
     class="w-48 h-48 md:w-64 md:h-64 object-contain"
     onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect width=%22100%25%22 height=%22100%25%22 fill=%23f8fafc/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%239ca3af%22 font-family=%22Fredoka, Arial, sans-serif%22 font-size=%2214%22>Imagen no disponible</text></svg>'">


            </div>
        <div class="flex flex-wrap justify-center gap-6">
          ${wordData.rows.map(row => {
            const colorKey = row.color ? row.color.toLowerCase() : 'blue';
            const c = COLORS[colorKey] || COLORS.blue;
            return `
              <div class="flex flex-col items-center">
                <div class="w-6 h-6 mb-2" style="color: ${c.main}">${getShapeSVG(row.shape)}</div>
                <span class="text-5xl md:text-8xl font-black tracking-tighter uppercase text-slate-800">${row.syllable}</span>
              </div>
            `;
          }).join('')}
        </div>
        <button onclick="speak('${wordData.word.replace(/'/g,"\\'")}', true)" class="bg-blue-600 text-white px-10 py-4 rounded-full font-black uppercase tracking-widest hover:bg-blue-700 transition-colors shadow-lg shadow-blue-200 mt-6">
          Â¡Escuchar otra vez! ðŸ”Š
        </button>
      `;
      document.getElementById('final-card').innerHTML = finalCardHTML;
      document.getElementById('result-area').classList.add('opacity-20', 'pointer-events-none');

      // Actualizar progreso inicial (0/X)
      updateProgress();

      // Volver al top para mejorar UX
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changeWord(idx) {
      currentWordIdx = parseInt(idx, 10) || 0;
      renderApp();
    }

    // --- ARREGLO PDF SIN ERRORES ---
    function drawShapePDF(doc, shape, x, y, size, rgb) {
      doc.setFillColor(rgb[0], rgb[1], rgb[2]);
      if(shape === 'Circle') {
        doc.circle(x + size/2, y + size/2, size/2, 'F');
      } else if(shape === 'Square') {
        doc.roundedRect(x, y, size, size, 1, 1, 'F');
      } else if(shape === 'Triangle') {
        // Triangle: (x+size/2,y) (x,y+size) (x+size,y+size)
        doc.triangle(x + size/2, y, x, y + size, x + size, y + size, 'F');
      } else {
        // Diamond o Star -> fallback cÃ­rculo (seguro)
        doc.circle(x + size/2, y + size/2, size/2, 'F');
      }
    }


    let IMAGE_MAP = {};
let GENERATED_BLOB = null;

async function loadZipImages(file){
  IMAGE_MAP = {};
  const zip = await JSZip.loadAsync(file);

  const promises = [];

  zip.forEach((path, entry) => {
    if (!entry.dir && path.match(/\.(jpg|jpeg|png)$/i)) {

      promises.push(
        entry.async("base64").then(data => {

          // solo nombre del archivo (sin carpetas)
          const fileName = path.split("/").pop().toLowerCase();

          // detectar extensiÃ³n real
          const ext = fileName.split(".").pop().toLowerCase();

          const mimeType =
            ext === "png"
              ? "image/png"
              : "image/jpeg";

          IMAGE_MAP[fileName] =
            `data:${mimeType};base64,${data}`;
        })
      );
    }
  });

  await Promise.all(promises);

  console.log("IMAGENES CARGADAS:", IMAGE_MAP);
}


 async function exportToPDF(preview = true) {

  const jsonText = document.getElementById("json-input").value;
  const zipFile = document.getElementById("zip-input").files[0];
  const pdfName = document.getElementById("pdf-name").value || "Album_Lectura_Magica";

  if(!jsonText){
    alert("Pega la DATA JSON");
    return;
  }

  if(!zipFile){
    alert("Sube el ZIP de imÃ¡genes");
    return;
  }

  try {
    DATA = JSON.parse(jsonText);
  } catch(e){
    alert("JSON invÃ¡lido");
    return;
  }

  await loadZipImages(zipFile);

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');

  for (let i = 0; i < DATA.length; i++) {
    const item = DATA[i];
    if (i > 0) doc.addPage('l', 'mm', 'a4');

    // ðŸ”µ TODO tu diseÃ±o original EXACTO
    doc.setFillColor(248, 250, 252);
    doc.rect(0, 0, 297, 210, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.line(148, 10, 148, 200);

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(100);
    doc.text("PRACTICA LOS SONIDOS", 74, 20, { align: 'center' });
    doc.text("PALABRA COMPLETA", 222, 20, { align: 'center' });

    item.rows.forEach((row, idx) => {
      const y = 35 + (idx * 45);
      const colorKey = row.color ? row.color.toLowerCase() : 'blue';
      const colorData = COLORS[colorKey] || COLORS['blue'];
      const rgb = colorData.rgb;

      for (let c = 0; c < 3; c++) {
        const x = 20 + (c * 42);
        doc.setDrawColor(rgb[0], rgb[1], rgb[2]);
        doc.setLineWidth(0.8);
        doc.roundedRect(x, y, 38, 35, 5, 5, 'D');
        drawShapePDF(doc, row.shape, x + 14, y + 4, 10, rgb);
        doc.setFontSize(38);
        doc.setTextColor(40);
        doc.text(row.syllable.toUpperCase(), x + 19, y + 28, { align: 'center' });
      }
    });

    // IMAGEN DESDE ZIP
    const imgKey = item.image.toLowerCase();
    if(IMAGE_MAP[imgKey]){
      doc.addImage(IMAGE_MAP[imgKey], 'JPEG', 185, 35, 75, 75);
    } else {
      doc.setDrawColor(200);
      doc.setFillColor(240);
      doc.roundedRect(185, 35, 75, 75, 3, 3, 'FD');
      doc.setFontSize(10);
      doc.text('Imagen no disponible', 222, 73, { align: 'center' });
    }

    const syllables = item.rows.map(r => r.syllable.toUpperCase());
    const fullWord = syllables.join("");
    const rightAreaCenter = 222;
    const maxAvailableWidth = 110;

    let chosenFont = 75;
    doc.setFontSize(chosenFont);

    while (doc.getTextWidth(fullWord) > maxAvailableWidth && chosenFont > 20) {
      chosenFont -= 2;
      doc.setFontSize(chosenFont);
    }

    doc.setTextColor(30);
    doc.text(fullWord, rightAreaCenter, 165, { align: 'center' });

    const totalWordWidth = doc.getTextWidth(fullWord);
    let currentX = rightAreaCenter - (totalWordWidth / 2);

    item.rows.forEach((row) => {
      const colorKey = row.color ? row.color.toLowerCase() : 'blue';
      const c = COLORS[colorKey] || COLORS.blue;
      const sylText = row.syllable.toUpperCase();
      const sylWidth = doc.getTextWidth(sylText);
      drawShapePDF(doc, row.shape, currentX + (sylWidth / 2) - 4, 132, 8, c.rgb);
      currentX += sylWidth;
    });

    doc.setFontSize(10);
    doc.setTextColor(150);
    doc.text(`PÃ¡gina ${i + 1} - Lectura MÃ¡gica`, 280, 200, { align: 'right' });
  }



  // ===== MARCA DE AGUA RANDOM =====
const totalPages = doc.getNumberOfPages();
const pageWidth = doc.internal.pageSize.getWidth();
const pageHeight = doc.internal.pageSize.getHeight();

for (let i = 1; i <= totalPages; i++) {
  doc.setPage(i);

  // ðŸ”¹ Marca vertical lateral
  const watermarkText = "FB: SUPER CURSOS TELGAM";
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.setTextColor(210, 210, 210);

  const textWidth = doc.getTextWidth(watermarkText);
  const visualHeight = textWidth;

  const margin = 30;
  const minY = margin + visualHeight;
  const maxY = pageHeight - margin;

  const randomY = Math.random() * (maxY - minY) + minY;

  doc.text(watermarkText, 15, randomY, { angle: 90 });

  // ðŸ”¹ Footer random horizontal
  const footerText = "FB: SUPER CURSOS TELGAM   www.narrion.site";
  doc.setFontSize(9);
  doc.setTextColor(150, 150, 150);

  const footerWidth = doc.getTextWidth(footerText);
  const minX = margin;
  const maxX = pageWidth - footerWidth - margin;

  const randomX = Math.random() * (maxX - minX) + minX;

  doc.text(footerText, randomX, pageHeight - 12);
}
// ===== FIN MARCA DE AGUA =====


  GENERATED_BLOB = doc.output("blob");

  if(preview){
    showPreview(GENERATED_BLOB);
  } else {
    doc.save(pdfName + ".pdf");
  }
}

function showPreview(blob){
  const url = URL.createObjectURL(blob);
  document.getElementById("pdf-preview-frame").src = url;
  document.getElementById("pdf-preview-modal").classList.remove("hidden");
}

function closePreview(){
  document.getElementById("pdf-preview-modal").classList.add("hidden");
}


  </script>

  <div id="pdf-preview-modal"
  class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">

  <div class="bg-white w-[95%] h-[90%] rounded-3xl overflow-hidden relative">

    <button onclick="closePreview()"
      class="absolute top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-xl">
      Cerrar
    </button>

    <button onclick="exportToPDF(false)"
      class="absolute top-4 right-32 bg-green-600 text-white px-4 py-2 rounded-xl">
      Descargar
    </button>

    <iframe id="pdf-preview-frame" class="w-full h-full"></iframe>

  </div>
</div>
</body>
</html>
